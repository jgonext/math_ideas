name: Publicación automática

on:
  push:
    branches:
      - master
    paths-ignore:
      - "CHANGELOG.md"

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Obtener último tag
        id: lasttag
        run: |
          TAG=$(git tag --sort=-v:refname | head -n 1)
          echo "last_tag=$TAG" >> $GITHUB_ENV

      - name: Calcular nueva versión vX.0.0
        id: version
        run: |
          if [ -z "${{ env.last_tag }}" ]; then
            NEW=v1.0.0
          else
            X=$(echo "${{ env.last_tag }}" | sed 's/v\([0-9]*\).*/\1/')
            X=$((X+1))
            NEW="v$X.0.0"
          fi
          echo "new_tag=$NEW" >> $GITHUB_ENV
          echo "Nueva versión: $NEW"

      - name: Generar CHANGELOG.md
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          echo "Generando CHANGELOG.md..."

          if [ -z "${{ env.last_tag }}" ]; then
            COMMITS=$(git log --pretty=format:"* %s (%h)")
          else
            COMMITS=$(git log ${{ env.last_tag }}..HEAD --pretty=format:"* %s (%h)")
          fi

          DATE=$(date +"%Y-%m-%d")

          {
            echo "## ${{ env.new_tag }} — $DATE"
            echo ""
            echo "$COMMITS"
            echo ""
            echo ""
          } > NEW_CHANGELOG.md

          if [ -f CHANGELOG.md ]; then
            cat CHANGELOG.md >> NEW_CHANGELOG.md
          fi

          mv NEW_CHANGELOG.md CHANGELOG.md

          git add CHANGELOG.md
          git commit -m "Actualiza CHANGELOG para ${{ env.new_tag }}" || true
          echo "Commit creado, sin push para evitar loop."

      - name: Actualizar rama gh-pages
        run: |
          git subtree split --prefix=math001 -b temp-gh-pages
          git push -f origin temp-gh-pages:gh-pages
          git branch -D temp-gh-pages

      - name: Crear y subir nuevo tag
        run: |
          git tag ${{ env.new_tag }}
          git push origin ${{ env.new_tag }}

      - name: Resumen final
        run: |
          echo "Publicación completada."
          echo "Versión generada: ${{ env.new_tag }}"
